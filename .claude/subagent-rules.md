# Claude Code Subagents 规则文档

## 目录

- [概述](#概述)
- [什么是子代理](#什么是子代理)
- [快速开始](#快速开始)
- [目录与文件位置](#目录与文件位置)
- [文件格式](#文件格式)
- [配置字段](#配置字段)
- [模型选择](#模型选择)
- [可用工具](#可用工具)
- [管理子代理](#管理子代理)
- [自动委派与显式调用](#自动委派与显式调用)
- [插件子代理](#插件子代理)
- [基于 CLI 的配置](#基于-cli-的配置)
- [最佳实践](#最佳实践)
- [高级用法](#高级用法)
- [示例子代理](#示例子代理)
  - [代码审查员](#代码审查员)
  - [调试器](#调试器)
  - [数据科学家](#数据科学家)
- [性能与注意事项](#性能与注意事项)
- [故障排除](#故障排除)
- [参考资源](#参考资源)

---

## 概述

Subagents（子代理）是 Claude Code 中用于特定任务的专门 AI 助手。它们拥有独立的上下文窗口、可配置的工具访问和自定义系统提示，适合针对性工作流与上下文隔离。

核心收益：
- 上下文保护：每个子代理在自己的上下文中工作，避免污染主对话。
- 专业聚焦：针对某一职责进行深入定制，提高成功率与一致性。
- 灵活权限：对子代理授予受限工具集，提升安全性与可控性。
- 可复用：同一子代理可在多个项目间共享与复用。

> 当任务与某子代理描述匹配时，Claude 可以自动委派给该子代理执行，并将结果返回到主会话。

---

## 什么是子代理

子代理是可被主会话自动或显式调用的预配置 AI 个性：
- 具有明确的目的与专业领域
- 拥有与主对话分离的上下文窗口
- 可限制可用的工具集合
- 使用自定义系统提示指导其行为

---

## 快速开始

1. 打开子代理界面：输入 `/agents`
2. 选择“创建新代理”，并选择项目级或用户级
3. 定义子代理：
   - 描述子代理用途与触发时机（建议包含“主动使用”等提示词）
   - 选择允许访问的工具（留空可继承全部工具）
   - 编辑系统提示（可按 `e` 在本地编辑器打开）
4. 保存后使用：
   - 让 Claude 自动委派；或
   - 显式调用（见下文示例）

---

## 目录与文件位置

子代理以带有 YAML 前言（frontmatter）的 Markdown 文件存储：

| 类型 | 位置 | 范围 | 优先级 |
| --- | --- | --- | --- |
| 项目子代理 | `.claude/agents/` | 仅当前项目可用 | 最高 |
| 用户子代理 | `~/.claude/agents/` | 所有项目可用 | 次高 |

当名称冲突时，项目级子代理优先于用户级子代理。

---

## 文件格式

子代理文件由 YAML 前言 + 正文组成：

```markdown
---
name: code-reviewer
description: 专家代码审查专家。主动审查代码质量、安全性与可维护性。
tools: Read, Grep, Glob, Bash
model: inherit
---

您是一位确保高标准代码质量和安全性的高级代码审查员。

被调用时：
1. 运行 git diff 查看最近的更改
2. 关注修改的文件
3. 立即开始审查并按优先级输出问题与修复建议
```

> YAML 前言声明元数据；正文为系统提示（系统指令）。

---

## 配置字段

- name（必填）：子代理的唯一名称。
- description（强烈建议）：一句话描述子代理职责与触发时机。
  - 建议包含“主动使用”“必须使用”等短语，促进自动委派。
- tools（可选）：允许使用的工具清单。
  - 逗号分隔字符串或数组形式均可；留空则继承主会话工具。
- model（可选）：模型选择。
  - `inherit`（默认）或显式模型名（如 `sonnet`）。
- 正文（必填）：子代理的系统提示，包含被调用时的步骤、产出格式与注意事项。

---

## 模型选择

- inherit：继承主会话模型配置。
- 指定模型：根据任务强度单独指定（如 `sonnet`）。

> 专业性高或需要更强上下文理解的子代理，可指定更强模型；对延迟敏感的可保持继承。

---

## 可用工具

- 工具遵循主会话的可用集合，可通过 `tools` 字段进行限制。
- 常见：`Read`, `Grep`, `Glob`, `Bash`，也可结合插件提供的工具。
- 安全建议：仅授予子代理完成职责所需的最小工具集（最小权限原则）。

---

## 管理子代理

推荐通过 `/agents` 管理：
- 查看与搜索子代理
- 创建项目级/用户级子代理
- 查看与编辑子代理提示与元数据

显式调用示例：

```text
> 使用 code-reviewer 子代理检查我最近的更改
> 使用 test-runner 子代理修复失败的测试
> 请 debugger 子代理调查这个错误
```

---

## 自动委派与显式调用

自动委派依据：
- 用户请求的任务描述
- 子代理 `description` 字段
- 当前上下文与可用工具

建议：在 `description` 中加入“主动使用/必须使用”等词以提高自动触发概率。任何时候也可通过显式提及子代理名称来调用。

---

## 插件子代理

- 插件可内置子代理，行为与自定义子代理相同，并出现在 `/agents` 中。
- 可显式调用：“使用来自 security-plugin 的 code-reviewer 代理”。
- 插件子代理通常位于插件自身的 `agents/` 目录（或插件清单指定路径）。

---

## 基于 CLI 的配置

可使用 `--agents` 以 JSON 定义临时子代理（优先级：项目级 > CLI > 用户级）：

```bash
claude --agents '{
  "code-reviewer": {
    "description": "专家代码审查员。在代码更改后主动使用。",
    "prompt": "您是一位高级代码审查员。专注于代码质量、安全性和最佳实践。",
    "tools": ["Read", "Grep", "Glob", "Bash"],
    "model": "sonnet"
  }
}'
```

> 适用于一次性或临时会话；稳定复用建议使用文件方式落盘并纳入版本控制。

---

## 最佳实践

- 从自动生成开始再个性化：先让 Claude 生成初版子代理，再迭代细化。
- 单一职责：让每个子代理专注一个明确目标，提升可预测性与性能。
- 详细且可执行的系统提示：包含步骤、检查清单、产出格式、边界与约束。
- 限制工具访问：只授予完成任务所需的最小工具集。
- 版本控制与共享：项目级子代理纳入仓库，团队可协作改进。

---

## 高级用法

- 链接子代理：

```text
> 首先使用 code-analyzer 子代理查找性能问题，然后使用 optimizer 子代理修复它们
```

- 动态选择：通过编写具体而行动导向的 `description`，提升自动选择准确度。

---

## 示例子代理

### 代码审查员

```markdown
---
name: code-reviewer
description: 专家代码审查专家。主动审查代码质量、安全性与可维护性。
tools: Read, Grep, Glob, Bash
model: inherit
---

您是一位确保高标准代码质量和安全性的高级代码审查员。

被调用时：
1. 运行 git diff 查看最近的更改
2. 专注于修改的文件
3. 立即开始审查

审查清单：
- 代码简单易读
- 函数与变量命名良好
- 没有重复代码
- 适当的错误处理
- 没有暴露的秘密或 API 密钥
- 实现了输入验证
- 良好的测试覆盖率
- 考虑了性能问题

按优先级组织反馈：
- 关键问题（必须修复）
- 警告（应该修复）
- 建议（可改进）
```

### 调试器

```markdown
---
name: debugger
description: 错误、测试失败和意外行为的调试专家。在遇到任何问题时主动使用。
tools: Read, Edit, Bash, Grep, Glob
---

您是专门从事根本原因分析的专家调试器。

被调用时：
1. 捕获错误消息和堆栈跟踪
2. 识别重现步骤
3. 隔离失败位置
4. 实施最小修复
5. 验证解决方案有效

对每个问题，提供：
- 根因解释与证据
- 具体代码修复
- 测试方法
- 预防建议
```

### 数据科学家

```markdown
---
name: data-scientist
description: SQL/BigQuery 分析专家。主动用于数据分析与查询任务。
tools: Bash, Read, Write
model: sonnet
---

您是专门从事 SQL 与 BigQuery 分析的数据科学家。

被调用时：
1. 明确分析需求
2. 编写高效 SQL 查询（含适当过滤与聚合）
3. 必要时使用 bq CLI
4. 总结结果并突出关键发现
5. 提供数据驱动的建议
```

---

## 性能与注意事项

- 上下文效率：子代理独立上下文可保护主对话，提高整体会话时长。
- 延迟权衡：每次调用子代理需重新收集上下文，可能增加延迟。
- 安全最小化：对高权限工具务必仅授予特定子代理并在 `description` 中限制使用场景。

---

## 故障排除

- 子代理未自动触发：增强 `description` 的行动导向与“主动使用”提示，或显式调用。
- 工具不可用：检查主会话工具集与子代理 `tools` 限制是否匹配。
- 名称冲突：同名时项目级优先生效；必要时重命名或清理重复。

---

## 参考资源

- 官方 Sub Agents 文档：[Claude Code 子代理](https://docs.claude.com/zh-CN/docs/claude-code/sub-agents)

---

本规则文档用于在本项目中规范化创建、使用与管理 Subagents。建议与 `slash-commands-rules.md` 与 `agent-skills-rules.md` 配套阅读与维护。

