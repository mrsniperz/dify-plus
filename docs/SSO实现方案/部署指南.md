# Dify SSO部署指南

> 版本: v1.0.0  
> 更新日期: 2025-11-19

## 目录
- [1. 方案一部署](#1-方案一部署)
- [2. 方案二部署](#2-方案二部署)
- [3. 环境配置](#3-环境配置)
- [4. 测试验证](#4-测试验证)
- [5. 故障排查](#5-故障排查)

---

## 1. 方案一部署

### 1.1 网站A后端部署

#### 步骤1: 安装依赖

```bash
pip install fastapi uvicorn requests pydantic cryptography
```

#### 步骤2: 配置环境变量

创建 `.env` 文件：

```bash
DIFY_BASE_URL=https://your-dify-domain.com
DIFY_SSO_SECRET=your-shared-secret-key-change-in-production
```

#### 步骤3: 启动服务

```bash
cd docs/SSO实现方案/代码示例/方案一/
uvicorn website_a_backend:app --host 0.0.0.0 --port 8000 --reload
```

### 1.2 网站A前端部署

#### 方式1: 静态文件部署

将 `website_a_frontend.html` 部署到Web服务器：

```bash
# Nginx配置示例
server {
    listen 80;
    server_name your-website-a.com;
    
    location / {
        root /var/www/sso-frontend;
        index website_a_frontend.html;
    }
    
    location /api/ {
        proxy_pass http://localhost:8000;
    }
}
```

#### 方式2: 集成到现有前端项目

将HTML中的JavaScript代码集成到您的前端框架中（React/Vue/Angular）。

### 1.3 Dify端配置

**无需修改Dify源码**，但需要确保：

1. Dify API可访问
2. CORS配置允许网站A的域名
3. 登录接口 `/console/api/login` 正常工作

---

## 2. 方案二部署

### 2.1 Dify后端修改

#### 步骤1: 添加SSO端点文件

```bash
# 复制SSO端点文件
cp docs/SSO实现方案/代码示例/方案二/dify_sso_endpoint.py \
   api/controllers/console/auth/sso_extend.py
```

#### 步骤2: 注册路由

编辑 `api/controllers/console/auth/__init__.py`：

```python
# 在文件末尾添加
from . import sso_extend
```

#### 步骤3: 配置环境变量

编辑 `api/.env` 或 `docker/.env`：

```bash
# SSO配置
SSO_SHARED_SECRET=your-super-secret-key-here-change-in-production
CONSOLE_WEB_URL=http://localhost:3000

# 确保以下配置正确
SECRET_KEY=your-jwt-secret-key
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=30
```

#### 步骤4: 重启Dify服务

**Docker部署**:
```bash
cd docker
docker-compose down
docker-compose up -d
```

**源码部署**:
```bash
cd api
# 如果使用UV
uv run python app.py

# 或使用传统方式
python app.py
```

### 2.2 Dify前端修改

#### 步骤1: 添加SSO回调页面

在Dify前端项目中添加路由：

**React Router示例**:
```javascript
// src/App.tsx
import SSOCallback from './pages/SSOCallback';

<Route path="/sso-callback" element={<SSOCallback />} />
```

**SSOCallback组件**:
```javascript
// src/pages/SSOCallback.tsx
import { useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';

export default function SSOCallback() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  
  useEffect(() => {
    const accessToken = searchParams.get('access_token');
    const refreshToken = searchParams.get('refresh_token');
    const redirect = searchParams.get('redirect') || '/';
    
    if (accessToken && refreshToken) {
      // 存储token
      localStorage.setItem('console_token', accessToken);
      localStorage.setItem('refresh_token', refreshToken);
      
      // 跳转
      navigate(redirect);
    } else {
      navigate('/login');
    }
  }, []);
  
  return <div>SSO登录处理中...</div>;
}
```

### 2.3 网站A客户端部署

```bash
cd docs/SSO实现方案/代码示例/方案二/
pip install fastapi uvicorn requests pydantic
uvicorn website_a_sso_client:app --host 0.0.0.0 --port 8000 --reload
```

---

## 3. 环境配置

### 3.1 必需的环境变量

| 变量名 | 说明 | 示例值 | 必需 |
|--------|------|--------|------|
| DIFY_BASE_URL | Dify API地址 | https://api.dify.ai | 是 |
| SSO_SHARED_SECRET | SSO共享密钥 | random-secret-key | 是 |
| SECRET_KEY | JWT签名密钥 | jwt-secret-key | 是 |
| CONSOLE_WEB_URL | Dify前端地址 | https://console.dify.ai | 是 |
| ACCESS_TOKEN_EXPIRE_MINUTES | Token有效期 | 60 | 否 |

### 3.2 安全配置建议

1. **生成强密钥**:
```bash
# 生成SSO共享密钥
python -c "import secrets; print(secrets.token_urlsafe(32))"

# 生成JWT密钥
python -c "import secrets; print(secrets.token_hex(32))"
```

2. **HTTPS配置**:
```nginx
# 强制HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 其他配置...
}
```

3. **CORS配置** (Dify API):
```python
# api/app.py
from flask_cors import CORS

CORS(app, origins=[
    "https://your-website-a.com",
    "https://your-dify-frontend.com"
])
```

---

## 4. 测试验证

### 4.1 功能测试清单

- [ ] 网站A登录表单正常显示
- [ ] 输入正确凭证可以成功登录
- [ ] Token正确存储到localStorage
- [ ] 成功跳转到Dify平台
- [ ] Dify平台显示已登录状态
- [ ] 刷新页面保持登录状态
- [ ] Token过期后自动刷新

### 4.2 测试脚本

**方案一测试**:
```bash
# 测试登录API
curl -X POST http://localhost:8000/api/sso/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```

**方案二测试**:
```bash
# 测试SSO端点
python3 << EOF
import hmac, hashlib, time
email = "test@example.com"
secret = "your-shared-secret"
timestamp = int(time.time())
message = f"{email}:{timestamp}"
signature = hmac.new(secret.encode(), message.encode(), hashlib.sha256).hexdigest()
print(f"http://localhost:5001/console/api/sso/login?email={email}&timestamp={timestamp}&signature={signature}")
EOF
```

---

## 5. 故障排查

### 5.1 常见问题

**问题1: Token验证失败**
- 检查SECRET_KEY是否一致
- 确认时间戳未过期
- 验证签名算法正确

**问题2: CORS错误**
- 配置Dify API的CORS策略
- 检查请求头是否正确

**问题3: 重定向失败**
- 确认CONSOLE_WEB_URL配置正确
- 检查前端路由是否存在

### 5.2 日志查看

**Dify API日志**:
```bash
# Docker部署
docker logs -f dify-api

# 源码部署
tail -f api/logs/app.log
```

**网站A后端日志**:
```bash
# 查看uvicorn日志
tail -f /var/log/website-a/access.log
```

