# Dify平台单点登录(SSO)实现方案 - 完整文档

> 📚 **文档版本**: v1.0.0  
> 📅 **创建日期**: 2025-11-19  
> 👤 **作者**: Cascade AI  
> 🏷️ **标签**: SSO, Dify, 单点登录, JWT, 认证集成

---

## 📖 文档概述

本文档提供了从外部网站到Dify平台的单点登录(SSO)完整实现方案，包括技术分析、代码示例、部署指南和安全最佳实践。

### 🎯 适用场景

- ✅ 已有用户系统，希望无缝集成Dify平台
- ✅ 需要统一认证入口，提升用户体验
- ✅ 企业内部系统集成，实现一次登录多处使用
- ✅ 第三方应用集成Dify服务

---

## 📂 文档结构

```
docs/SSO实现方案/
├── README.md                          # 本文件 - 总览文档
├── Dify-SSO完整实现方案.md            # 核心技术方案
├── 部署指南.md                        # 详细部署步骤
├── 安全最佳实践.md                    # 安全配置指南
└── 代码示例/
    ├── 方案一/                        # API Token传递方案
    │   ├── website_a_backend.py       # 网站A后端实现
    │   └── website_a_frontend.html    # 网站A前端页面
    └── 方案二/                        # 自定义SSO端点方案
        ├── dify_sso_endpoint.py       # Dify SSO端点
        ├── dify_frontend_sso_callback.html  # Dify前端回调页面
        └── website_a_sso_client.py    # 网站A SSO客户端
```

---

## 🚀 快速开始

### 方案选择

| 方案 | 难度 | 是否需要修改Dify | 推荐场景 |
|------|------|-----------------|----------|
| **方案一**: API Token传递 | ⭐⭐ | ❌ 否 | 快速实现，同域部署 |
| **方案二**: 自定义SSO端点 | ⭐⭐⭐ | ✅ 是 | 企业级应用，安全要求高 |

### 5分钟快速体验（方案一）

#### 步骤1: 启动网站A后端

```bash
# 安装依赖
pip install fastapi uvicorn requests pydantic cryptography

# 配置环境变量
export DIFY_BASE_URL=http://localhost:5001
export DIFY_SSO_SECRET=test-secret-key

# 启动服务
cd docs/SSO实现方案/代码示例/方案一/
uvicorn website_a_backend:app --reload
```

#### 步骤2: 打开前端页面

```bash
# 在浏览器中打开
open website_a_frontend.html
# 或访问 http://localhost:8000/docs 查看API文档
```

#### 步骤3: 测试登录

1. 输入Dify账号邮箱和密码
2. 点击"登录并跳转到Dify"
3. 自动跳转到Dify平台并完成登录

---

## 📋 核心功能特性

### ✨ 方案一特性

- 🔐 **无需修改Dify源码**: 直接调用Dify AP[object Object]*快速集成**: 30分钟内完成部署
- 🔒 **Token加密传输**: 使用Fernet加密算法
- ⏱️ **时效性验证**: 防止重放攻击
- 📱 **响应式设计**: 支持移动端访问

### ✨ 方案二特性

- 🛡️ **基于签名认证**: HMAC-SHA256签名验证
- 🔑 **无需密码传输**: 仅需用户邮箱
- 🎯 **灵活集成方式**: 支持GET/POST两种方式
- 🔄 **自动Token刷新**: 无感知续期
- 📊 **完整审计日志**: 记录所有SSO事件

---

## 🔧 技术架构

### Dify认证机制

```
┌─────────────────────────────────────────────────────────┐
│                    Dify认证流程                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  用户登录 → 验证凭证 → 生成JWT Token                     │
│                           ↓                             │
│                    TokenPair {                          │
│                      access_token  (60分钟)             │
│                      refresh_token (30天)               │
│                    }                                    │
│                           ↓                             │
│                    存储到Redis + 返回客户端               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 方案一架构图

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│ 网站A    │ ───> │ 网站A    │ ───> │ Dify     │ ───> │ Dify     │
│ 前端     │      │ 后端     │      │ API      │      │ 前端     │
└──────────┘      └──────────┘      └──────────┘      └──────────┘
    │                  │                  │                  │
    │ 1.提交凭证        │ 2.调用登录API     │ 3.返回Token       │ 4.自动登录
    │                  │                  │                  │
```

### 方案二架构图

```
┌──────────┐      ┌──────────┐      ┌──────────┐
│ 网站A    │ ───> │ Dify     │ ───> │ Dify     │
│ 客户端   │      │ SSO端点  │      │ 前端     │
└──────────┘      └──────────┘      └──────────┘
    │                  │                  │
    │ 1.生成签名        │ 2.验证+生成Token  │ 3.自动登录
    │                  │                  │
```

---

## 📚 详细文档导航

### 1️⃣ [Dify-SSO完整实现方案.md](./Dify-SSO完整实现方案.md)

**内容概要**:
- Dify认证机制深度分析
- Token类型与结构详解
- 两种SSO方案的完整实现
- API端点说明和代码示例

**适合人群**: 开发人员、架构师

### 2️⃣ [部署指南.md](./部署指南.md)

**内容概要**:
- 分步骤部署说明
- 环境配置详解
- 测试验证方法
- 常见问题排查

**适合人群**: 运维人员、部署工程师

### 3️⃣ [安全最佳实践.md](./安全最佳实践.md)

**内容概要**:
- Token安全管理
- 传输加密配置
- 攻击防护措施
- 监控与审计方案
- 应急响应流程

**适合人群**: 安全工程师、架构师

---

## 🔐 安全性说明

### 安全特性

- ✅ **HTTPS强制**: 所有通信必须使用HTTPS
- ✅ **Token加密**: 敏感数据加密传输
- ✅ **签名验证**: HMAC-SHA256防篡改
- ✅ **时效性检查**: 防止重放攻击
- ✅ **速率限制**: 防止暴力破解
- ✅ **审计日志**: 完整的操作记录

### 安全建议

1. **生产环境必须使用HTTPS**
2. **定期轮换密钥** (建议每90天)
3. **启用速率限制** (防止DDoS)
4. **监控异常登录** (IP变化、频繁登录)
5. **定期审计日志** (检测安全事件)

---

## 🛠️ 技术栈

### 后端技术

- **Python**: 3.10+
- **FastAPI**: 现代化Web框架
- **Flask**: Dify原生框架
- **JWT**: JSON Web Token认证
- **Redis**: Token存储和缓存
- **Cryptography**: 加密库

### 前端技术

- **HTML5/CSS3/JavaScript**: 原生Web技术
- **React** (可选): 现代前端框架
- **Fetch API**: HTTP请求

---

## 📞 支持与反馈

### 问题反馈

如遇到问题，请按以下步骤操作：

1. 查看 [部署指南.md](./部署指南.md) 的故障排查章节
2. 检查日志文件获取详细错误信息
3. 提交Issue并附上错误日志

### 贡献指南

欢迎提交改进建议和代码优化！

---

## 📄 许可证

本文档和代码示例遵循 MIT 许可证。

---

## 🎉 总结

本SSO方案提供了两种灵活的实现方式，满足不同场景的需求：

- **方案一**: 适合快速集成，无需修改Dify源码
- **方案二**: 适合企业级应用，安全性更高

选择适合您的方案，按照文档步骤操作，即可快速实现Dify平台的单点登录功能！

**祝您部署顺[object Object]
