# 准备阶段与多项目并行 - 测试场景与验收标准

覆盖门禁、事件重排、插单护栏、策略模板、多项目资源共享、公平性与KPI。

## A. 基础门禁
- __A1 关键工装缺口阻断__
  - 前置：`CRANE-1` 不可用。
  - 期望：`critical_tools_ready` 门禁不通过；工包不可开工；`/prep/summary` 风险=high。
- __A2 非关键工装仅阻断子项__
  - 前置：某非关键工具缺失。
  - 期望：仅相关准备子项被阻断，工包其他子项可排程。
- __A3 航材必须齐套__
  - 前置：`must_kit=true` 物料未到。
  - 期望：相关门禁不通过，任务不可启动；ETA到达后自动放行并重排。

## B. 事件与重排
- __B1 ETA 延后__
  - 操作：`POST /prep/events/apply` 修改物料 ETA +90min。
  - 期望：仅未开始任务重排；输出差异 `diff`；makespan 合理增加。
- __B2 SAP 指令延迟__
  - 前置：SAP 接收超时。
  - 期望：准备窗口后移；`/prep/summary` 暴露 SLA 风险。
- __B3 天气事件（台风）__
  - 前置：行车不可用若干小时。
  - 期望：受影响区间冻结，资源再分配到其它项目可执行子项。

## C. 多项目并行与资源共享
- __C1 行车独占冲突__
  - 前置：两个工包同时需要 `CRANE-1`。
  - 期望：无重叠 `NoOverlap`；按策略分配顺序；输出让位说明（若启用插单）。
- __C2 工位共享与切换成本__
  - 前置：共享 `BAY-A`；设置切换成本。
  - 期望：计划减少切换次数；批处理相似任务。
- __C3 公平性（最小化最大延误）__
  - 前置：三个项目优先级接近。
  - 期望：启用公平策略时，各项目延误趋于均衡。

## D. 插单策略与护栏
- __D1 触发插单__
  - 操作：高优项目 SLA 缓冲 ≤ 12h。
  - 期望：允许抢占未开始/可中断子项；生成“让位说明+影响评估+恢复计划”。
- __D2 护栏 - 次数限制__
  - 前置：同一项目当日已被抢占 N 次。
  - 期望：第 N+1 次拦截并给出原因。
- __D3 护栏 - 时长限制__
  - 前置：单次抢占已达 M 小时。
  - 期望：拒绝进一步延长抢占，提示恢复时间窗。

## E. 策略模板切换与灰度
- __E1 模板切换__
  - 操作：`POST /config/priority-template:apply` 切换为 `protect_sla`。
  - 期望：目标权重更新；新生成或重排结果体现对 SLA 的更强保护。
- __E2 灰度发布__
  - 操作：指定 20% 范围与 120 分钟灰度。
  - 期望：仅作用于灰度范围；KPI 监控达到阈值后方可全量切换。

## F. KPI 与可观测性
- __F1 KPI 输出完整性__
  - 期望：`/prep/summary` 返回门禁通过率、预计准备完成时间、SLA 风险、关键路径、资源利用率。
- __F2 事件影响分析__
  - 期望：`diff` 列出受影响任务、延误时长、资源再分配；审计日志可追溯。

## 验收标准
- 所有必测用例通过率 ≥ 95%。
- 关键门禁相关用例（A 组）100% 通过。
- 重排性能满足 SLO：单工包≤5s，多工包≤20s；重排≤对应上限的40%。
- 审计项完整：插单场景均产出影响评估、让位说明、恢复计划与审批信息。
